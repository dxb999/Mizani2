â€<!DOCTYPE html>
â€<html lang="ar" dir="rtl">
â€<head>
â€  <meta charset="UTF-8" />
â€  <title>Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</title>
â€  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
â€  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
â€  <style>
â€    body { font-family: Tahoma; background: #f0f0f0; margin: 0; padding: 20px; }
â€    h2 { color: #0a3e7d; text-align: center; }
â€    .box { background: white; padding: 15px; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
â€    #map { height: 300px; border-radius: 10px; margin-top: 10px; }
â€    #popupNotice {
â€      display: none;
â€      position: fixed;
â€      top: 20px;
â€      right: 20px;
â€      background: #0a3e7d;
â€      color: white;
â€      padding: 15px;
â€      border-radius: 10px;
â€      z-index: 9999;
â€      box-shadow: 0 0 10px rgba(0,0,0,0.2);
â€      font-size: 16px;
    }
â€    button {
â€      padding: 10px;
â€      background: #0a3e7d;
â€      color: white;
â€      border: none;
â€      border-radius: 6px;
â€      margin-top: 10px;
â€      cursor: pointer;
â€      width: 100%;
    }
â€    button:hover {
â€      background: #083463;
    }
â€    .log {
â€      background: #f9f9f9;
â€      margin-top: 10px;
â€      padding: 10px;
â€      border-radius: 6px;
    }
â€  </style>
â€</head>
â€<body>
â€  <div id="popupNotice">ğŸš— ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø­Ø±ÙƒØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©!</div>
â€  <h2>ğŸš˜ Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø°ÙƒÙŠ</h2>

â€  <div class="box">
â€    <label for="carSelect">ğŸš™ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</label>
â€    <select id="carSelect">
â€      <option value="Ø±Ù†Ø¬ Ø±ÙˆÙØ±">Ø±Ù†Ø¬ Ø±ÙˆÙØ±</option>
â€      <option value="ÙƒØ§Ù…Ø±ÙŠ">ÙƒØ§Ù…Ø±ÙŠ</option>
â€      <option value="ØªÙˆÙŠÙˆØªØ§">ØªÙˆÙŠÙˆØªØ§</option>
â€    </select>
â€  </div>

â€  <div class="box">
â€    <h3>ğŸ” Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØªØ¨Ø¹</h3>
â€    <p>Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span id="speed">0</span> ÙƒÙ…/Ø³</p>
â€    <p>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø©: <span id="distance">0</span> ÙƒÙ…</p>
â€    <p>Ø§Ù„Ø²Ù…Ù†: <span id="duration">00:00:00</span></p>
â€  </div>

â€  <div class="box">
â€    <h3>ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø³Ø§Ø±</h3>
â€    <div id="map"></div>
â€  </div>

â€  <div class="box">
â€    <h3>ğŸ“‘ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
â€    <div id="tripLogs"></div>
â€    <button onclick="clearTrips()">ğŸ—‘ï¸ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø±Ø­Ù„Ø§Øª</button>
â€  </div>

  <!-- ØµÙˆØª Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡ -->
â€  <audio id="startSound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" preload="auto"></audio>

â€  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
â€  <script>

â€let map, pathLine, iconMarker;
â€let pathCoords = [];
â€let totalDistance = 0;
â€let maxSpeed = 0;
â€let startTime = null;
â€let lastPosition = null;
â€let isTracking = false;
â€let trackingTimer = null;
â€let autoStopTimeout = null;
â€let tripLogs = JSON.parse(localStorage.getItem("tripLogs") || "[]");

â€function initMap() {
â€  map = L.map('map').setView([25.276987, 55.296249], 13);
â€  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
â€    attribution: '&copy; OpenStreetMap contributors'
â€  }).addTo(map);
}

â€function haversine(lat1, lon1, lat2, lon2) {
â€  const R = 6371;
â€  const dLat = (lat2 - lat1) * Math.PI / 180;
â€  const dLon = (lon2 - lon1) * Math.PI / 180;
â€  const a = Math.sin(dLat / 2) ** 2 +
â€            Math.cos(lat1 * Math.PI / 180) *
â€            Math.cos(lat2 * Math.PI / 180) *
â€            Math.sin(dLon / 2) ** 2;
â€  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
â€  return R * c;
}

â€function startTracking() {
â€  if (isTracking) return;

â€  isTracking = true;
â€  startTime = new Date();
â€  totalDistance = 0;
â€  pathCoords = [];
â€  maxSpeed = 0;
â€  pathLine = null;

â€  showPopup("ğŸš— ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø­Ø±ÙƒØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©!");
â€  document.getElementById("startSound").play();

â€  if (iconMarker) map.removeLayer(iconMarker);

â€  trackingTimer = setInterval(updateDuration, 1000);

â€  navigator.geolocation.watchPosition(pos => {
â€    const { latitude, longitude, speed } = pos.coords;
â€    const latLng = [latitude, longitude];

â€    if (!iconMarker) {
â€      iconMarker = L.marker(latLng, {
â€        icon: L.divIcon({ html: "ğŸš—", className: "", iconSize: [30, 30] })
â€      }).addTo(map);
â€    } else {
â€      iconMarker.setLatLng(latLng);
    }

â€    map.setView(latLng, 16);
â€    pathCoords.push(latLng);

â€    if (!pathLine) {
â€      pathLine = L.polyline(pathCoords, { color: 'blue' }).addTo(map);
â€    } else {
â€      pathLine.setLatLngs(pathCoords);
    }

â€    if (lastPosition) {
â€      const dist = haversine(lastPosition.lat, lastPosition.lon, latitude, longitude);
â€      if (dist > 0.01) {
â€        totalDistance += dist;
â€        document.getElementById("distance").textContent = totalDistance.toFixed(2);
â€        clearTimeout(autoStopTimeout);
â€        autoStopTimeout = setTimeout(stopTracking, 60000);
      }
    }

â€    lastPosition = { lat: latitude, lon: longitude };

â€    const kmh = (speed * 3.6).toFixed(1);
â€    if (!isNaN(kmh)) {
â€      document.getElementById("speed").textContent = kmh;
â€      if (parseFloat(kmh) > maxSpeed) maxSpeed = parseFloat(kmh);
    }
â€  }, err => {
â€    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹:", err);
â€  }, { enableHighAccuracy: true });
}

â€function stopTracking() {
â€  if (!isTracking) return;
â€  isTracking = false;
â€  clearInterval(trackingTimer);
â€  clearTimeout(autoStopTimeout);

â€  const endTime = new Date();
â€  const duration = Math.floor((endTime - startTime) / 1000);
â€  const hours = String(Math.floor(duration / 3600)).padStart(2, '0');
â€  const minutes = String(Math.floor((duration % 3600) / 60)).padStart(2, '0');
â€  const seconds = String(duration % 60).padStart(2, '0');

â€  const car = document.getElementById("carSelect").value;

â€  tripLogs.push({
â€    car,
â€    date: new Date().toLocaleDateString(),
â€    start: startTime.toLocaleTimeString(),
â€    end: endTime.toLocaleTimeString(),
â€    distance: totalDistance.toFixed(2),
â€    maxSpeed: maxSpeed.toFixed(1),
â€    duration: `${hours}:${minutes}:${seconds}`,
â€    path: [...pathCoords]
  });

â€  localStorage.setItem("tripLogs", JSON.stringify(tripLogs));
â€  renderLogs();
}

â€function updateDuration() {
â€  const now = new Date();
â€  const seconds = Math.floor((now - startTime) / 1000);
â€  const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
â€  const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
â€  const s = String(seconds % 60).padStart(2, '0');
â€  document.getElementById("duration").textContent = `${h}:${m}:${s}`;
}

â€function renderLogs() {
â€  const container = document.getElementById("tripLogs");
â€  container.innerHTML = "";
â€  tripLogs.forEach((trip, index) => {
â€    const div = document.createElement("div");
â€    div.className = "log";
â€    div.innerHTML = `
â€      <strong>ğŸš˜ ${trip.car}</strong><br>
â€      ğŸ“… ${trip.date} | â° ${trip.start} â†’ ${trip.end}<br>
â€      ğŸ›£ï¸ ${trip.distance} ÙƒÙ… | â±ï¸ ${trip.duration} | ğŸš€ ${trip.maxSpeed} ÙƒÙ…/Ø³<br>
â€      <button onclick="viewTrip(${index})">Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
â€      <button onclick="deleteTrip(${index})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
    `;
â€    container.appendChild(div);
  });
}

â€function deleteTrip(index) {
â€  if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø­Ù„Ø©ØŸ")) {
â€    tripLogs.splice(index, 1);
â€    localStorage.setItem("tripLogs", JSON.stringify(tripLogs));
â€    renderLogs();
  }
}

â€function clearTrips() {
â€  if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø­Ù„Ø§ØªØŸ")) {
â€    tripLogs = [];
â€    localStorage.removeItem("tripLogs");
â€    renderLogs();
  }
}

â€function viewTrip(index) {
â€  const trip = tripLogs[index];
â€  if (!map) return;
â€  if (pathLine) map.removeLayer(pathLine);
â€  if (iconMarker) map.removeLayer(iconMarker);
â€  pathLine = L.polyline(trip.path, { color: 'red' }).addTo(map);
â€  map.fitBounds(pathLine.getBounds());
}

â€function showPopup(msg) {
â€  const el = document.getElementById("popupNotice");
â€  el.textContent = msg;
â€  el.style.display = "block";
â€  setTimeout(() => el.style.display = "none", 4000);
}

â€window.onload = () => {
â€  initMap();
â€  renderLogs();

â€  navigator.geolocation.watchPosition(pos => {
â€    const { latitude, longitude, speed } = pos.coords;
â€    if ((speed && speed * 3.6 > 5) || !isTracking) {
â€      startTracking();
    }
â€  }, err => {
â€    console.warn("GPS ØºÙŠØ± Ù…ØªÙˆÙØ±:", err);
â€  }, { enableHighAccuracy: true });
};
â€  </script>
â€</body>
â€</html>
