<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ูุธุงู ุชุชุจุน ุงูุณูุงุฑุฉ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: Tahoma; background: #f5f7fa; margin: 0; padding: 20px; }
    h2 { color: #0a3e7d; }
    .box { background: white; padding: 15px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    #map { height: 300px; border-radius: 8px; margin-top: 10px; }
    .popup { background: #0a3e7d; color: white; padding: 10px; border-radius: 8px; position: fixed; top: 20px; right: 20px; display: none; z-index: 9999; }
  </style>
</head>
<body>

<div class="popup" id="popup">๐ ุชู ุงูุชุดุงู ุญุฑูุฉ ุงูุณูุงุฑุฉ!</div>

<div class="box">
  <h2>๐ ุจูุงูุงุช ุงูุณูุงุฑุฉ</h2>
  <select id="carType" onchange="loadCarData()">
    <option value="range">ุฑูุฌ ุฑููุฑ</option>
    <option value="camry">ูุงูุฑู</option>
  </select>
  <br><br>
  <label>ุนุฏุงุฏ ุงููููููุชุฑุงุช:</label>
  <input type="number" id="currentKm" placeholder="ูู ุงูุญุงูู" onchange="saveCarData()">
  <label>ุงููุณุงูุฉ ุงููุชุจููุฉ ุจุงูุจุชุฑูู:</label>
  <input type="number" id="fuelLeft" placeholder="ุงููุณุงูุฉ ุงูููููุฉ" onchange="saveCarData()">
</div>

<div class="box">
  <h2>๐ฐ๏ธ ุชุชุจุน ูุจุงุดุฑ</h2>
  <p id="status">ุงูุญุงูุฉ: ๐ก ูู ูุถุน ุงูุงูุชุธุงุฑ...</p>
  <p>ุงูุณุฑุนุฉ ุงูุญุงููุฉ: <span id="speed">0</span> ูู/ุณ</p>
  <p>ุงูุฒูู ููุฐ ุงูุงูุทูุงู: <span id="duration">0</span></p>
  <p>ุงููุณุงูุฉ ุงูููุทูุนุฉ: <span id="distance">0.00</span> ูู</p>
  <div id="map"></div>
</div>

<div class="box">
  <h2>๐ ุณุฌู ุงูุฑุญูุงุช</h2>
  <div id="logs"></div>
  <button onclick="clearLogs()">๐๏ธ ุญุฐู ุฌููุน ุงูุฑุญูุงุช</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let carIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/743/743007.png', iconSize: [32, 32] });

let map, marker, polyline;
let coords = [], isTracking = false;
let startTime, lastLat = null, lastLon = null;
let distance = 0, maxSpeed = 0, timer;
let autoStopTimer = null;
let lastCarType = 'range';

// ๐ ุนุฑุถ ุชูุจูู
function showPopup(msg) {
  const popup = document.getElementById("popup");
  popup.textContent = msg;
  popup.style.display = "block";
  setTimeout(() => popup.style.display = "none", 4000);
}

// ๐ ุฅุนุฏุงุฏ ุงูุฎุฑูุทุฉ
function initMap() {
  map = L.map('map').setView([25.2, 55.3], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
}

// โฝ ุญูุธ ุงูุจูุงูุงุช ุญุณุจ ููุน ุงูุณูุงุฑุฉ
function saveCarData() {
  const car = document.getElementById("carType").value;
  localStorage.setItem(`${car}_km`, document.getElementById("currentKm").value);
  localStorage.setItem(`${car}_fuel`, document.getElementById("fuelLeft").value);
}

// ๐ฆ ุชุญููู ุงูุจูุงูุงุช ุญุณุจ ููุน ุงูุณูุงุฑุฉ
function loadCarData() {
  const car = document.getElementById("carType").value;
  document.getElementById("currentKm").value = localStorage.getItem(`${car}_km`) || "0";
  document.getElementById("fuelLeft").value = localStorage.getItem(`${car}_fuel`) || "0";
  lastCarType = car;
}

// ๐งญ ุญุณุงุจ ุงููุณุงูุฉ
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// โฑ๏ธ ุจุฏุก ุงูุชุชุจุน
function startTracking() {
  isTracking = true;
  startTime = Date.now();
  coords = [];
  distance = 0;
  maxSpeed = 0;
  document.getElementById("status").textContent = "ุงูุญุงูุฉ: โ ุงูุชุชุจุน ูุดุท...";
  if (polyline) map.removeLayer(polyline);
  timer = setInterval(updateDuration, 1000);
}

// ๐ ุงูุชููู ุงูุชููุงุฆู
function stopTracking() {
  isTracking = false;
  clearInterval(timer);
  clearTimeout(autoStopTimer);
  const durationSec = Math.floor((Date.now() - startTime) / 1000);
  const prevKm = parseFloat(document.getElementById("currentKm").value || "0");
  const prevFuel = parseFloat(document.getElementById("fuelLeft").value || "0");

  const log = {
    date: new Date().toLocaleString(),
    car: lastCarType,
    distance: distance.toFixed(2),
    duration: formatTime(durationSec),
    speed: maxSpeed.toFixed(1),
    prevKm: prevKm.toFixed(2),
    prevFuel: prevFuel.toFixed(2),
    path: coords
  };

  // ุชุญุฏูุซ ุนุฏุงุฏ ุงูุณูุงุฑุฉ ูุงูุจุชุฑูู
  document.getElementById("currentKm").value = (prevKm + distance).toFixed(2);
  document.getElementById("fuelLeft").value = Math.max(prevFuel - distance, 0).toFixed(2);
  saveCarData();

  // ุญูุธ ุงูุณุฌู
  const logs = JSON.parse(localStorage.getItem("trip_logs") || "[]");
  logs.push(log);
  localStorage.setItem("trip_logs", JSON.stringify(logs));
  showLogs();
  document.getElementById("status").textContent = "ุงูุญุงูุฉ: ๐ค ุชู ุญูุธ ุงูุฑุญูุฉ.";
}

// โฑ๏ธ ุชุญุฏูุซ ุงูุฒูู
function updateDuration() {
  const seconds = Math.floor((Date.now() - startTime) / 1000);
  document.getElementById("duration").textContent = formatTime(seconds);
}

// โ ุชุญููู ุงูุฒูู
function formatTime(sec) {
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${m} ุฏูููุฉ ${s} ุซุงููุฉ`;
}

// ๐ ุนุฑุถ ุงูุฑุญูุงุช
function showLogs() {
  const logs = JSON.parse(localStorage.getItem("trip_logs") || "[]");
  const container = document.getElementById("logs");
  container.innerHTML = "";
  logs.reverse().forEach((log, i) => {
    const div = document.createElement("div");
    div.className = "box";
    div.innerHTML = `
      ๐ <strong>ููุน ุงูุณูุงุฑุฉ:</strong> ${log.car}<br>
      ๐๏ธ <strong>ุงูุชุงุฑูุฎ:</strong> ${log.date}<br>
      โฑ๏ธ <strong>ุงููุฏุฉ:</strong> ${log.duration}<br>
      ๐ฃ๏ธ <strong>ุงููุณุงูุฉ:</strong> ${log.distance} ูู<br>
      ๐ <strong>ุฃูุตู ุณุฑุนุฉ:</strong> ${log.speed} ูู/ุณ<br>
      ๐ข <strong>ุนุฏุงุฏ ุงูุณูุงุฑุฉ ุงูุณุงุจู:</strong> ${log.prevKm}<br>
      โฝ <strong>ุนุฏุงุฏ ุงูุจุชุฑูู ุงูุณุงุจู:</strong> ${log.prevFuel} ูู<br>
      ๐บ๏ธ <a href="#" onclick='showMap(${JSON.stringify(log.path)})'>ุนุฑุถ ุงููุณุงุฑ</a>
    `;
    container.appendChild(div);
  });
}

// ๐บ๏ธ ุนุฑุถ ุฎุฑูุทุฉ ุงููุณุงุฑ
function showMap(path) {
  if (!map) return;
  if (polyline) map.removeLayer(polyline);
  polyline = L.polyline(path, { color: 'blue' }).addTo(map);
  map.fitBounds(polyline.getBounds());
}

// โ ุญุฐู ุงูุฑุญูุงุช
function clearLogs() {
  if (confirm("ูู ุชุฑูุฏ ุญุฐู ุฌููุน ุงูุฑุญูุงุชุ")) {
    localStorage.removeItem("trip_logs");
    showLogs();
  }
}

// ๐ฆ ุจุฏุก ุชุดุบูู GPS
if ("geolocation" in navigator) {
  initMap();
  loadCarData();
  showLogs();
  navigator.geolocation.watchPosition(pos => {
    const { latitude, longitude, speed } = pos.coords;
    if (!marker) {
      marker = L.marker([latitude, longitude], { icon: carIcon }).addTo(map);
    } else {
      marker.setLatLng([latitude, longitude]);
    }
    coords.push([latitude, longitude]);
    map.setView([latitude, longitude], 15);

    const kmh = ((speed || 0) * 3.6).toFixed(1);
    document.getElementById("speed").textContent = kmh;
    if (parseFloat(kmh) > maxSpeed) maxSpeed = parseFloat(kmh);

    if (lastLat !== null && lastLon !== null) {
      const d = getDistance(lastLat, lastLon, latitude, longitude);
      if (d > 0.01) {
        distance += d;
        document.getElementById("distance").textContent = distance.toFixed(2);
        if (!isTracking) {
          showPopup("๐ ุชู ุงูุชุดุงู ุญุฑูุฉ ุงูุณูุงุฑุฉ!");
          startTracking();
        }
        clearTimeout(autoStopTimer);
        autoStopTimer = setTimeout(() => {
          if (isTracking) stopTracking();
        }, 30000);
      }
    }
    lastLat = latitude;
    lastLon = longitude;
  }, err => {
    document.getElementById("status").textContent = "ุงูุญุงูุฉ: ๐ต ูุดู ุชุญุฏูุฏ ุงููููุน.";
  }, { enableHighAccuracy: true });
} else {
  alert("ุงููุชุตูุญ ูุง ูุฏุนู ุชุชุจุน ุงููููุน.");
}
</script>
</body>
</html>
