<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ููุฒุงูู - ุตูุงูุฉ ุงูุณูุงุฑุฉ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Tahoma; background: #f4f7fa; color: #333; margin: 0; padding: 0; }
    header { background: #0a3e7d; color: white; padding: 20px; text-align: center; }
    section { padding: 20px; }
    input, select, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
    .box { background: white; border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .alert { background: #fce4e4; color: #b00020; padding: 10px; border-radius: 6px; margin-top: 10px; }
    .ok { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 6px; margin-top: 10px; }
    button { background: #0a3e7d; color: white; border: none; cursor: pointer; }
    button:hover { background: #083463; }
    #map { height: 300px; border-radius: 10px; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

<header>
  <h1>ููุฒุงูู</h1>
  <p>ูุธุงู ุชุชุจุน ูุชูุจูู ูุตูุงูุฉ ุงูุณูุงุฑุงุช</p>
</header>

<section>
  <div class="box">
    <h3>๐ ุจูุงูุงุช ุงูุณูุงุฑุฉ</h3>
    <select id="carType">
      <option value="ุฑูุฌ ุฑููุฑ">๐ ุฑูุฌ ุฑููุฑ</option>
      <option value="ูุงูุฑู">๐ ูุงูุฑู</option>
    </select>
    <input type="number" id="currentKm" placeholder="ุนุฏุฏ ุงููููููุชุฑุงุช ุงูุญุงููุฉ">
    <input type="number" id="fuelRange" placeholder="ุงููุณุงูุฉ ุงูููููุฉ ุจุงูุจุชุฑูู (ูู)">
    <input type="date" id="lastServiceDate">
  </div>

  <div class="box">
    <h3>๐ฐ๏ธ ุชุชุจุน ุงูููุงุฏุฉ</h3>
    <p>๐ ููุน ุงูุณูุงุฑุฉ ุงูุฌุงุฑู ุชุชุจุนูุง: <strong id="activeCar">โ</strong></p>
    <p>ุงููุณุงูุฉ ุงูููุทูุนุฉ: <span id="distance">0</span> ูู</p>
    <p>โฑ๏ธ ุงูููุช ููุฐ ุจุฏุก ุงูุชุชุจุน: <span id="driveTime">0</span></p>
    <p>๐ ุงูุณุฑุนุฉ ุงูุญุงููุฉ: <span id="speed">0</span> ูู/ุณ</p>
    <button onclick="startTracking()">ุงุจุฏุฃ ุงูููุงุฏุฉ</button>
    <button onclick="stopTracking()">ุฃููู ุงูุชุชุจุน</button>
    <div id="status" class="ok">ุจุฅููุงูู ุจุฏุก ุงูุชุชุจุน ุงูุขู.</div>
  </div>

  <div class="box">
    <h3>๐ ุชูุจูู ุงูุตูุงูุฉ</h3>
    <div id="alertBox" class="ok">๐ ุงูุตูุงูุฉ ุบูุฑ ูุทููุจุฉ ุญุงูููุง</div>
  </div>

  <div class="box">
    <h3>๐บ๏ธ ุฎุฑูุทุฉ ุงูุญุฑูุฉ</h3>
    <div id="map"></div>
  </div>

  <div class="box">
    <h3>๐งฎ ุนุฏุงุฏ ุงููููููุชุฑุงุช</h3>
    <p>ุงููููููุชุฑุงุช ุงูุฃุณุงุณูุฉ: <span id="baseKm">0</span> ูู</p>
    <p>ุงููุณุงูุฉ ุงูููุทูุนุฉ: <span id="addedKm">0</span> ูู</p>
    <p><strong>๐ ุงููุฌููุน ุงูููู: <span id="totalKm">0</span> ูู</strong></p>
  </div>

  <div class="box">
    <h3>โฝ ุนุฏุงุฏ ุงูุจุชุฑูู</h3>
    <p>ุงููุณุงูุฉ ุงูููููุฉ ุจุงูุจุชุฑูู: <span id="fuelLeft">0</span> ูู</p>
  </div>

  <div class="box">
    <h3>๐ ุจูุงูุงุช ุงูููุงุฏุฉ ุงูุณุงุจูุฉ</h3>
    <div id="driveLogs"></div>
    <button onclick="generateRSS()">๐ฅ ุชูููุฏ ููู RSS</button>
    <button onclick="clearDriveLogs()">๐๏ธ ุญุฐู ุฌููุน ุจูุงูุงุช ุงูุฑุญูุงุช</button>
  </div>

  <div class="box">
    <h3>๐ ุจูุงูุงุช ุงูุณูุงุฑุฉ</h3>
    <select id="carSelect" onchange="localStorage.setItem('currentCar', this.value)">
      <option value="ุฑูุฌ ุฑููุฑ">ุฑูุฌ ุฑููุฑ</option>
      <option value="ูุงูุฑู">ูุงูุฑู</option>
    </select>
    <input type="number" id="currentKm" placeholder="ุนุฏุฏ ุงููููููุชุฑุงุช ุงูุญุงููุฉ"
           onchange="localStorage.setItem('currentKm', this.value)">
    <input type="number" id="fuelRange" placeholder="ุงููุณุงูุฉ ุงูููููุฉ ุจุงูุจุชุฑูู (ูู)"
           onchange="localStorage.setItem('fuelRange', this.value)">
    <input type="date" id="lastServiceDate">
  </div>

  <!-- ุชุชุจุน ุงูููุงุฏุฉ ูุงููููุน ูุฎุฑูุทุฉ -->
  <div class="box">
    <h3>๐ฐ๏ธ ุชุชุจุน ุงูููุงุฏุฉ</h3>
    <p>ุงููุณุงูุฉ ุงูููุทูุนุฉ: <span id="distance">0</span> ูู</p>
    <p>โฑ๏ธ ุงูููุช ููุฐ ุจุฏุก ุงูุชุชุจุน: <span id="driveTime">0</span></p>
    <p>๐ ุงูุณุฑุนุฉ ุงูุญุงููุฉ: <span id="speed">0</span> ูู/ุณ</p>
    <button onclick="startTracking()">ุงุจุฏุฃ ุงูููุงุฏุฉ</button>
    <button onclick="stopTracking()">ุฃููู ุงูุชุชุจุน</button>
    <div id="status" class="ok">ุจุฅููุงูู ุจุฏุก ุงูุชุชุจุน ุงูุขู.</div>
  </div>

  <!-- ุชูุจูู ุงูุตูุงูุฉ -->
  <div class="box">
    <h3>๐ ุชูุจูู ุงูุตูุงูุฉ</h3>
    <div id="alertBox" class="ok">๐ ุงูุตูุงูุฉ ุบูุฑ ูุทููุจุฉ ุญุงูููุง</div>
  </div>

  <!-- ุงูุฎุฑูุทุฉ -->
  <div class="box">
    <h3>๐บ๏ธ ุฎุฑูุทุฉ ุงูุญุฑูุฉ</h3>
    <div id="map"></div>
  </div>

  <!-- ุนุฏุงุฏ ุงููููููุชุฑุงุช -->
  <div class="box">
    <h3>๐งฎ ุนุฏุงุฏ ุงููููููุชุฑุงุช</h3>
    <p>ุงููููููุชุฑุงุช ุงูุฃุณุงุณูุฉ: <span id="baseKm">0</span> ูู</p>
    <p>ุงููุณุงูุฉ ุงูููุทูุนุฉ: <span id="addedKm">0</span> ูู</p>
    <p><strong>๐ ุงููุฌููุน ุงูููู: <span id="totalKm">0</span> ูู</strong></p>
  </div>

  <!-- ุนุฏุงุฏ ุงูุจุชุฑูู -->
  <div class="box">
    <h3>โฝ ุนุฏุงุฏ ุงูุจุชุฑูู</h3>
    <p>๐ ุงููุณุงูุฉ ุงููุชุจููุฉ ุจุงูุจุชุฑูู: <strong><span id="fuelLeft">0</span> ูู</strong></p>
  </div>

  <!-- ุจูุงูุงุช ุงูุฑุญูุงุช -->
  <div class="box">
    <h3>๐ ุจูุงูุงุช ุงูููุงุฏุฉ ุงูุณุงุจูุฉ</h3>
    <div id="driveLogs"></div>
    <button onclick="generateRSS()">๐ฅ ุชุญุฏูุซ RSS</button>
    <button onclick="clearDriveLogs()">๐๏ธ ูุณุญ ูู ุจูุงูุงุช ุงูุฑุญูุงุช</button>
  </div>
</section>

<script>
let watchId, lastPosition = null, totalDistance = 0;
let startTime, driveInterval, maxSpeed = 0;
let pathCoords = [], pathLine, map;
let driveLogs = [], sessionStartCoords = null, sessionEndCoords = null;
let totalDistanceAllTrips = 0;

function initMap() {
  map = L.map('map').setView([25.276987, 55.296249], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
}

function updateMap(lat, lon) {
  const newPoint = [lat, lon];
  pathCoords.push(newPoint);
  if (!pathLine) {
    pathLine = L.polyline(pathCoords, { color: 'blue' }).addTo(map);
  } else {
    pathLine.setLatLngs(pathCoords);
  }
  map.setView(newPoint, 15);
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

function updateOdometer() {
  const base = parseFloat(localStorage.getItem("currentKm") || "0");
  const total = base + totalDistanceAllTrips + totalDistance;
  document.getElementById("baseKm").textContent = base.toFixed(2);
  document.getElementById("addedKm").textContent = (totalDistanceAllTrips + totalDistance).toFixed(2);
  document.getElementById("totalKm").textContent = total.toFixed(2);
}

function updateFuelMeter() {
  const fuelBase = parseFloat(localStorage.getItem("fuelRange") || "0");
  const fuelLeft = fuelBase - (totalDistanceAllTrips + totalDistance);
  document.getElementById("fuelLeft").textContent = (fuelLeft > 0 ? fuelLeft : 0).toFixed(2);
}

function startTracking() {
  const selectedCar = document.getElementById("carSelect").value;
  document.getElementById("activeCar").textContent = selectedCar;

  const currentKm = parseFloat(document.getElementById("currentKm").value || "0");
  const fuelRange = parseFloat(document.getElementById("fuelRange").value || "0");

  localStorage.setItem("currentCar", selectedCar);
  localStorage.setItem("currentKm", currentKm.toString());
  localStorage.setItem("fuelRange", fuelRange.toString());

  totalDistance = 0; maxSpeed = 0; pathCoords = []; pathLine = null;
  sessionStartCoords = null; sessionEndCoords = null;
  document.getElementById("distance").textContent = "0";
  document.getElementById("speed").textContent = "0";
  document.getElementById("driveTime").textContent = "0";
  updateOdometer();
  updateFuelMeter();
  initMap();

  startTime = new Date();
  driveInterval = setInterval(updateDriveTime, 1000);

  watchId = navigator.geolocation.watchPosition(pos => {
    const { latitude, longitude, speed } = pos.coords;
    updateMap(latitude, longitude);

    if (speed !== null && !isNaN(speed)) {
      const kmh = (speed * 3.6).toFixed(1);
      document.getElementById("speed").textContent = kmh;
      if (speed * 3.6 > maxSpeed) maxSpeed = speed * 3.6;
    }

    if (!sessionStartCoords) sessionStartCoords = [latitude, longitude];
    sessionEndCoords = [latitude, longitude];

    if (lastPosition) {
      const dist = haversine(lastPosition.latitude, lastPosition.longitude, latitude, longitude);
      if (dist > 0.01) {
        totalDistance += dist;
        totalDistanceAllTrips += dist;
        document.getElementById("distance").textContent = totalDistance.toFixed(2);
        updateOdometer();
        updateFuelMeter();
        checkServiceAlert();
      }
    }

    lastPosition = { latitude, longitude };
    document.getElementById("status").textContent = "๐ ุงูุชุชุจุน ูุดุท...";
  }, () => {
    document.getElementById("status").textContent = "๐ต ุฎุทุฃ ูู ุชุชุจุน ุงููููุน";
  }, { enableHighAccuracy: true });
}

function stopTracking() {
  if (watchId) navigator.geolocation.clearWatch(watchId);
  if (driveInterval) clearInterval(driveInterval);
  document.getElementById("status").textContent = "โ ุชู ุฅููุงู ุงูุชุชุจุน";

  const now = new Date();
  const elapsedMs = now - startTime;
  const totalSeconds = Math.floor(elapsedMs / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  const formattedDuration = `${hours} ุณ ${minutes} ุฏ ${seconds} ุซ`;

  const log = {
    car: document.getElementById("carSelect").value,
    start: sessionStartCoords,
    end: sessionEndCoords,
    distance: totalDistance.toFixed(2),
    duration: formattedDuration,
    maxSpeed: maxSpeed.toFixed(1)
  };

  const logs = JSON.parse(localStorage.getItem("driveLogs") || "[]");
  logs.push(log);
  localStorage.setItem("driveLogs", JSON.stringify(logs));
  generateRSS();
  renderDriveLogs();
}

function updateDriveTime() {
  const now = new Date();
  const elapsedMs = now - startTime;
  const totalSeconds = Math.floor(elapsedMs / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  const formatted = `${hours} ุณ ${minutes} ุฏ ${seconds} ุซ`;
  document.getElementById("driveTime").textContent = formatted;
}

function generateRSS() {
  const logs = JSON.parse(localStorage.getItem("driveLogs") || "[]");
  let rssContent = `<?xml version="1.0" encoding="UTF-8" ?>\n<rss version="2.0">\n<channel>\n`;
  rssContent += `<title>ุจูุงูุงุช ุงูููุงุฏุฉ - ููุฒุงูู</title>\n<link>https://example.com/</link>\n<description>ุฎูุงุตุงุช ุงูุฑุญูุงุช</description>\n`;

  logs.forEach((log, index) => {
    const pubDate = new Date().toUTCString();
    rssContent += `<item>\n`;
    rssContent += `<title>ุฑุญูุฉ ${index + 1} - ${log.car}</title>\n`;
    rssContent += `<description>ุงููุณุงูุฉ: ${log.distance} ูู - ุงููุฏุฉ: ${log.duration} - ุงูุณุฑุนุฉ ุงููุตูู: ${log.maxSpeed} ูู/ุณ</description>\n`;
    rssContent += `<pubDate>${pubDate}</pubDate>\n`;
    rssContent += `</item>\n`;
  });

  rssContent += `</channel>\n</rss>`;
  localStorage.setItem("rssFeed", rssContent);
}

function renderDriveLogs() {
  const container = document.getElementById("driveLogs");
  container.innerHTML = "";
  const logs = JSON.parse(localStorage.getItem("driveLogs") || "[]");
  totalDistanceAllTrips = logs.reduce((sum, log) => sum + parseFloat(log.distance), 0);
  updateOdometer();
  updateFuelMeter();

  logs.forEach((log, index) => {
    const div = document.createElement("div");
    div.className = "box";
    div.innerHTML = `
      <strong>ุฑุญูุฉ #${index + 1}</strong><br>
      ๐ ุงูุณูุงุฑุฉ: ${log.car}<br>
      ๐บ๏ธ ูู: [${log.start?.[0]?.toFixed(4)}, ${log.start?.[1]?.toFixed(4)}]<br>
      ๐ ุฅูู: [${log.end?.[0]?.toFixed(4)}, ${log.end?.[1]?.toFixed(4)}]<br>
      โฑ๏ธ ุงููุฏุฉ: ${log.duration}<br>
      ๐ ุงููุณุงูุฉ: ${log.distance} ูู<br>
      ๐ ุฃุนูู ุณุฑุนุฉ: ${log.maxSpeed} ูู/ุณ
    `;
    container.appendChild(div);
  });
}

function clearDriveLogs() {
  if (confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ูุณุญ ุฌููุน ุจูุงูุงุช ุงูุฑุญูุงุชุ")) {
    localStorage.removeItem("driveLogs");
    totalDistanceAllTrips = 0;
    renderDriveLogs();
  }
}

window.onload = () => {
  const car = localStorage.getItem("currentCar");
  const currentKm = localStorage.getItem("currentKm");
  const fuelRange = localStorage.getItem("fuelRange");

  if (car) document.getElementById("carSelect").value = car;
  if (currentKm) document.getElementById("currentKm").value = currentKm;
  if (fuelRange) document.getElementById("fuelRange").value = fuelRange;

  renderDriveLogs();
  generateRSS();
};
</script>
