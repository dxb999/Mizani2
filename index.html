<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ููุฒุงูู - ุตูุงูุฉ ุงูุณูุงุฑุฉ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { font-family: Tahoma; background: #f4f7fa; color: #333; margin: 0; padding: 0; }
    header { background: #0a3e7d; color: white; padding: 20px; text-align: center; }
    section { padding: 20px; }
    input, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
    .box { background: white; border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .alert { background: #fce4e4; color: #b00020; padding: 10px; border-radius: 6px; }
    .ok { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 6px; }
    button { background: #0a3e7d; color: white; border: none; cursor: pointer; }
    button:hover { background: #083463; }
    #map { height: 300px; border-radius: 10px; }
  </style>
</head>
<body>
  <header>
    <h1>ููุฒุงูู</h1>
    <p>ูุธุงู ุชุชุจุน ูุชูุจูู ูุตูุงูุฉ ุงูุณูุงุฑุงุช</p>
  </header>

  <section>
    <div class="box">
      <h3>๐ ุจูุงูุงุช ุงูุณูุงุฑุฉ</h3>
      <input type="text" id="carType" placeholder="ููุน ุงูุณูุงุฑุฉ" />
      <input type="number" id="currentKm" placeholder="ุนุฏุฏ ุงููููููุชุฑุงุช ุงูุญุงููุฉ" />
      <input type="date" id="lastServiceDate" />
      <input type="number" id="fuelKm" placeholder="ุงููุณุงูุฉ ุงูููููุฉ ุจุงูุจุชุฑูู ุงูุญุงูู (ูู)" />
    </div>

    <div class="box">
      <h3>๐ฐ๏ธ ุชุชุจุน ุงูููุงุฏุฉ</h3>
      <p>ุงููุณุงูุฉ ุงูููุทูุนุฉ: <span id="distance">0</span> ูู</p>
      <p>โฑ๏ธ ุงูููุช: <span id="driveTime">0</span></p>
      <p>๐ ุงูุณุฑุนุฉ: <span id="speed">0</span> ูู/ุณ</p>
      <button onclick="startTracking()">ุงุจุฏุฃ ุงูููุงุฏุฉ</button>
      <button onclick="stopTracking()">ุฃููู ุงูุชุชุจุน</button>
      <div id="status" class="ok">๐ ุจุฅููุงูู ุจุฏุก ุงูุชุชุจุน.</div>
    </div>

    <div class="box">
      <h3>๐ ุชูุจูู ุงูุตูุงูุฉ</h3>
      <div id="alertBox" class="ok">๐ ุงูุตูุงูุฉ ุบูุฑ ูุทููุจุฉ ุญุงููุงู</div>
    </div>

    <div class="box">
      <h3>๐บ๏ธ ุฎุฑูุทุฉ</h3>
      <div id="map"></div>
    </div>

    <div class="box">
      <h3>๐งฎ ุนุฏุงุฏ ุงููููููุชุฑุงุช</h3>
      <p>ุงูุฃุณุงุณู: <span id="baseKm">0</span> ูู</p>
      <p>ุงูููุทูุน: <span id="addedKm">0</span> ูู</p>
      <p><strong>๐ ุงูุฅุฌูุงูู: <span id="totalKm">0</span> ูู</strong></p>
    </div>

    <div class="box">
      <h3>โฝ ุนุฏุงุฏ ุงูุจุชุฑูู</h3>
      <p>ุงููุณุงูุฉ ุงููุชุจููุฉ ุจุงูุจุชุฑูู ุงูุญุงูู: <span id="fuelLeft">0</span> ูู</p>
    </div>

    <div class="box">
      <h3>๐ ุจูุงูุงุช ุงูููุงุฏุฉ ุงูุณุงุจูุฉ</h3>
      <div id="driveLogs"></div>
      <button onclick="generateRSS()">๐ ุชุญุฏูุซ RSS</button>
    </div>
  </section>

  <script>
    let watchId, lastPosition = null, totalDistance = 0;
    let startTime, driveInterval, maxSpeed = 0;
    let pathCoords = [], pathLine, map;
    let driveLogs = [], sessionStartCoords = null, sessionEndCoords = null;

    function initMap() {
      map = L.map("map").setView([25.276987, 55.296249], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap",
      }).addTo(map);
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = ((lat2 - lat1) * Math.PI) / 180;
      const dLon = ((lon2 - lon1) * Math.PI) / 180;
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(lat1 * Math.PI / 180) *
          Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function updateOdometer() {
      const base = parseFloat(document.getElementById("currentKm").value || 0);
      document.getElementById("baseKm").textContent = base.toFixed(2);
      document.getElementById("addedKm").textContent = totalDistance.toFixed(2);
      document.getElementById("totalKm").textContent = (base + totalDistance).toFixed(2);

      const fuelStart = parseFloat(document.getElementById("fuelKm").value || 0);
      const fuelRemaining = Math.max(fuelStart - totalDistance, 0);
      document.getElementById("fuelLeft").textContent = fuelRemaining.toFixed(1);
    }

    function updateDriveTime() {
      const now = new Date();
      const seconds = Math.floor((now - startTime) / 1000);
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      document.getElementById("driveTime").textContent = `${h}ุณ ${m}ุฏ ${s}ุซ`;
    }

    function updateMap(lat, lon) {
      const point = [lat, lon];
      pathCoords.push(point);
      if (!pathLine) pathLine = L.polyline(pathCoords, { color: "blue" }).addTo(map);
      else pathLine.setLatLngs(pathCoords);
      map.setView(point, 15);
    }

    function checkServiceAlert() {
      const currentKm = parseFloat(document.getElementById("currentKm").value || 0);
      const lastDate = new Date(document.getElementById("lastServiceDate").value);
      const now = new Date();
      const diffDays = Math.floor((now - lastDate) / (1000 * 60 * 60 * 24));
      const kmLimit = currentKm + 5000;
      const timeLimit = 90;
      const totalKm = currentKm + totalDistance;

      const box = document.getElementById("alertBox");
      if (totalKm >= kmLimit || diffDays >= timeLimit) {
        box.className = "alert";
        box.innerHTML = `โ๏ธ ุงูุชุฑุจ ููุนุฏ ุงูุตูุงูุฉ<br>ุงููุณุงูุฉ: ${totalKm.toFixed(2)} ูู<br>ููุฐ ุงูุตูุงูุฉ: ${diffDays} ููู`;
      } else {
        box.className = "ok";
        box.innerHTML = `๐ ุงูุตูุงูุฉ ุบูุฑ ูุทููุจุฉ<br>ุงููุณุงูุฉ: ${totalKm.toFixed(2)} ูู<br>ููุฐ ุงูุตูุงูุฉ: ${diffDays} ููู`;
      }
    }

    function startTracking() {
      totalDistance = 0; maxSpeed = 0; pathCoords = []; pathLine = null;
      sessionStartCoords = null; sessionEndCoords = null;
      initMap(); updateOdometer();
      document.getElementById("distance").textContent = "0";
      startTime = new Date();
      driveInterval = setInterval(updateDriveTime, 1000);

      watchId = navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude, speed } = pos.coords;
        updateMap(latitude, longitude);
        if (!sessionStartCoords) sessionStartCoords = [latitude, longitude];
        sessionEndCoords = [latitude, longitude];
        if (lastPosition) {
          const dist = haversine(lastPosition.latitude, lastPosition.longitude, latitude, longitude);
          if (dist > 0.01) {
            totalDistance += dist;
            document.getElementById("distance").textContent = totalDistance.toFixed(2);
            updateOdometer(); checkServiceAlert();
          }
        }
        lastPosition = { latitude, longitude };
        document.getElementById("speed").textContent = (speed * 3.6).toFixed(1);
        document.getElementById("status").textContent = "๐ ุงูุชุชุจุน ูุดุท...";
      }, () => {
        document.getElementById("status").textContent = "๐ต ุฎุทุฃ ูู ุงููููุน";
      }, { enableHighAccuracy: true });
    }

    function stopTracking() {
      if (watchId) navigator.geolocation.clearWatch(watchId);
      if (driveInterval) clearInterval(driveInterval);
      document.getElementById("status").textContent = "โ ุชู ุฅููุงู ุงูุชุชุจุน";

      const end = new Date();
      const seconds = Math.floor((end - startTime) / 1000);
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;

      const log = {
        start: sessionStartCoords,
        end: sessionEndCoords,
        distance: totalDistance.toFixed(2),
        duration: `${h}ุณ ${m}ุฏ ${s}ุซ`,
        maxSpeed: maxSpeed.toFixed(1),
      };

      driveLogs.push(log);
      localStorage.setItem("driveLogs", JSON.stringify(driveLogs));
      generateRSS(); renderDriveLogs();
    }

    function renderDriveLogs() {
      const container = document.getElementById("driveLogs");
      container.innerHTML = "";
      const logs = JSON.parse(localStorage.getItem("driveLogs") || "[]");
      driveLogs = logs;

      logs.forEach((log, i) => {
        const div = document.createElement("div");
        div.className = "box";
        div.innerHTML = `
          <strong>ุฑุญูุฉ #${i + 1}</strong><br>
          ๐บ๏ธ ูู: [${log.start?.[0]?.toFixed(4)}, ${log.start?.[1]?.toFixed(4)}]<br>
          ๐ ุฅูู: [${log.end?.[0]?.toFixed(4)}, ${log.end?.[1]?.toFixed(4)}]<br>
          โฑ๏ธ ุงููุฏุฉ: ${log.duration}<br>
          ๐ ุงููุณุงูุฉ: ${log.distance} ูู<br>
          ๐ ุงูุณุฑุนุฉ ุงููุตูู: ${log.maxSpeed} ูู/ุณ`;
        container.appendChild(div);
      });
    }

    function generateRSS() {
      const logs = JSON.parse(localStorage.getItem("driveLogs") || "[]");
      let rss = `<?xml version="1.0" encoding="UTF-8" ?>\n<rss version="2.0"><channel>\n`;
      rss += `<title>ุจูุงูุงุช ุงูููุงุฏุฉ - ููุฒุงูู</title>\n<link>https://example.com/</link>\n<description>ุฎูุงุตุงุช ุงูููุงุฏุฉ</description>\n`;
      logs.forEach((log, i) => {
        rss += `<item>\n<title>ุฑุญูุฉ ${i + 1}</title>\n`;
        rss += `<description>ุงููุณุงูุฉ: ${log.distance} ูู - ุงููุฏุฉ: ${log.duration}</description>\n`;
        rss += `<pubDate>${new Date().toUTCString()}</pubDate>\n</item>\n`;
      });
      rss += `</channel></rss>`;
      localStorage.setItem("rssFeed", rss);
    }

    window.onload = () => {
      renderDriveLogs();
      generateRSS();
    };
  </script>
</body>
</html>
