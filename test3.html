<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù…ÙŠØ²Ø§Ù†ÙŠ - ØªØªØ¨Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { font-family: Tahoma; background: #f4f7fa; color: #333; margin: 0; padding: 0; }
    header { background: #0a3e7d; color: white; padding: 20px; text-align: center; }
    section { padding: 20px; }
    .box { background: white; border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    #map { height: 300px; border-radius: 10px; margin-top: 10px; }
    #popupNotice {
      display: none;
      position: fixed;
      top: 20px;
      right: 20px;
      background: #0a3e7d;
      color: white;
      padding: 15px;
      border-radius: 10px;
      z-index: 9999;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      font-size: 16px;
    }
  </style>
</head>
<body>

<header>
  <h1>Ù…ÙŠØ²Ø§Ù†ÙŠ</h1>
  <p>Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø§Ù„Ø±Ø­Ù„Ø§Øª - ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</p>
</header>

<div id="popupNotice">ğŸš— ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø­Ø±ÙƒØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©ØŒ Ø¨Ø¯Ø£ Ø§Ù„ØªØªØ¨Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§...</div>

<section>
  <div class="box">
    <h3>ğŸ›°ï¸ Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø­ÙŠ</h3>
    <p>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø©: <span id="distance">0</span> ÙƒÙ…</p>
    <p>â±ï¸ Ø§Ù„ÙˆÙ‚Øª: <span id="duration">00:00</span></p>
    <p>ğŸš€ Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span id="speed">0</span> ÙƒÙ…/Ø³</p>
    <div id="map"></div>
    <p id="status">ğŸ” ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø­Ø±ÙƒØ©...</p>
  </div>

  <div class="box">
    <h3>ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª</h3>
    <div id="logs"></div>
  </div>
</section>

<script>
let map, pathLine, watchId, tracking = false, startTime, autoStopTimer;
let coords = [], totalDistance = 0;
let lastLat = null, lastLon = null, lastMoveTime = null;

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
function initMap() {
  map = L.map('map').setView([25.2, 55.3], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  pathLine = L.polyline([], { color: 'blue' }).addTo(map);
}

// Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
function showPopup(msg) {
  const el = document.getElementById("popupNotice");
  el.textContent = msg;
  el.style.display = "block";
  setTimeout(() => el.style.display = "none", 4000);
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ†
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ø±Ø­Ù„Ø©
function startTracking() {
  coords = [];
  totalDistance = 0;
  pathLine.setLatLngs([]);
  document.getElementById("distance").textContent = "0";
  document.getElementById("duration").textContent = "00:00";
  startTime = Date.now();
  tracking = true;
  updateTimer();
}

// Ø¥ÙŠÙ‚Ø§Ù ÙˆØªØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
function stopTracking() {
  tracking = false;
  const endTime = Date.now();
  const duration = Math.round((endTime - startTime)/1000);
  const mins = String(Math.floor(duration / 60)).padStart(2, '0');
  const secs = String(duration % 60).padStart(2, '0');

  const log = {
    distance: totalDistance.toFixed(2),
    duration: `${mins}:${secs}`,
    path: [...coords]
  };

  const logs = JSON.parse(localStorage.getItem("driveLogs") || "[]");
  logs.push(log);
  localStorage.setItem("driveLogs", JSON.stringify(logs));
  renderLogs();
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª
function updateTimer() {
  if (!tracking) return;
  const now = Date.now();
  const elapsed = Math.floor((now - startTime) / 1000);
  const mins = String(Math.floor(elapsed / 60)).padStart(2, '0');
  const secs = String(elapsed % 60).padStart(2, '0');
  document.getElementById("duration").textContent = `${mins}:${secs}`;
  setTimeout(updateTimer, 1000);
}

// Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª
function renderLogs() {
  const logs = JSON.parse(localStorage.getItem("driveLogs") || "[]");
  const container = document.getElementById("logs");
  container.innerHTML = "";

  logs.forEach((log, i) => {
    const div = document.createElement("div");
    div.innerHTML = `
      <hr><strong>Ø±Ø­Ù„Ø© #${i+1}</strong><br>
      â±ï¸ Ø§Ù„Ù…Ø¯Ø©: ${log.duration}<br>
      ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©: ${log.distance} ÙƒÙ…<br>
      ğŸ—ºï¸ Ù†Ù‚Ø§Ø·: ${log.path.length}
    `;
    container.appendChild(div);
  });
}

// Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹
function startWatch() {
  watchId = navigator.geolocation.watchPosition(pos => {
    const { latitude, longitude, speed } = pos.coords;
    map.setView([latitude, longitude], 15);
    pathLine.addLatLng([latitude, longitude]);
    coords.push([latitude, longitude]);

    if (tracking) {
      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
      if (lastLat !== null && lastLon !== null) {
        const d = haversine(lastLat, lastLon, latitude, longitude);
        totalDistance += d;
        document.getElementById("distance").textContent = totalDistance.toFixed(2);
      }

      // Ø§Ù„Ø³Ø±Ø¹Ø©
      const kmh = speed ? (speed * 3.6).toFixed(1) : "0";
      document.getElementById("speed").textContent = kmh;

      clearTimeout(autoStopTimer);
      autoStopTimer = setTimeout(() => {
        document.getElementById("status").textContent = "â›” ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ.";
        stopTracking();
      }, 60000); // ØªÙˆÙ‚Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø¯Ù‚ÙŠÙ‚Ø© ØªÙˆÙ‚Ù
    }

    if (!tracking && lastLat !== null && lastLon !== null) {
      const dist = haversine(lastLat, lastLon, latitude, longitude);
      const timeDiff = Date.now() - (lastMoveTime || Date.now());
      if (dist > 0.03 && timeDiff < 10000) {
        showPopup("ğŸš— ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø­Ø±ÙƒØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©ØŒ Ø¨Ø¯Ø£ Ø§Ù„ØªØªØ¨Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§...");
        document.getElementById("status").textContent = "âœ… Ø§Ù„ØªØªØ¨Ø¹ Ù†Ø´Ø·...";
        startTracking();
      }
      lastMoveTime = Date.now();
    }

    lastLat = latitude;
    lastLon = longitude;

  }, err => {
    document.getElementById("status").textContent = "ğŸ“µ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹";
  }, { enableHighAccuracy: true });
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
window.onload = () => {
  initMap();
  renderLogs();
  if (navigator.geolocation) {
    startWatch();
  } else {
    document.getElementById("status").textContent = "ğŸš« Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ";
  }
};
</script>
</body>
</html>
