<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù…ÙŠØ²Ø§Ù†ÙŠ - ØµÙŠØ§Ù†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { font-family: Tahoma; background: #f4f7fa; color: #333; margin: 0; padding: 0; }
    header { background: #0a3e7d; color: white; padding: 20px; text-align: center; }
    section { padding: 20px; }
    input, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
    .box { background: white; border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .alert { background: #fce4e4; color: #b00020; padding: 10px; border-radius: 6px; margin-top: 10px; }
    .ok { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 6px; margin-top: 10px; }
    button { background: #0a3e7d; color: white; border: none; cursor: pointer; }
    button:hover { background: #083463; }
    #map { height: 300px; border-radius: 10px; }
  </style>
</head>
<body>

<header>
  <h1>Ù…ÙŠØ²Ø§Ù†ÙŠ</h1>
  <p>Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ ÙˆØªÙ†Ø¨ÙŠÙ‡ Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</p>
</header>

<section>
  <div class="box">
    <h3>ğŸš˜ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©</h3>
    <select id="carType" onchange="switchCar(this.value)">
      <option value="range">Ø±Ù†Ø¬ Ø±ÙˆÙØ±</option>
      <option value="camry">ÙƒØ§Ù…Ø±ÙŠ</option>
    </select>
    <input type="number" id="currentKm" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©">
    <input type="number" id="fuelRange" placeholder="Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ù…ÙƒÙ†Ø© Ø¨Ø§Ù„Ø¨ØªØ±ÙˆÙ„ (ÙƒÙ…)">
    <input type="date" id="lastServiceDate">
  </div>

  <div class="box">
    <h3>ğŸ›°ï¸ ØªØªØ¨Ø¹ Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</h3>
    <p>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø©: <span id="distance">0</span> ÙƒÙ…</p>
    <p>â±ï¸ Ø§Ù„ÙˆÙ‚Øª Ù…Ù†Ø° Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹: <span id="driveTime">0</span></p>
    <p>ğŸš€ Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span id="speed">0</span> ÙƒÙ…/Ø³</p>
    <button onclick="manualStart()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</button>
    <button onclick="stopTracking()">Ø£ÙˆÙ‚Ù Ø§Ù„ØªØªØ¨Ø¹</button>
    <div id="status" class="ok">ğŸš— ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ù„Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø­Ø±ÙƒØ©</div>
  </div>

  <div class="box">
    <h3>ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±ÙƒØ©</h3>
    <div id="map"></div>
  </div>
</section>
  <script>
let map, watchId, driveInterval, autoStopTimeout;
let totalDistance = 0, maxSpeed = 0;
let startTime, lastPosition = null;
let sessionStartCoords = null, sessionEndCoords = null;
let pathCoords = [], pathLine = null;
let driveLogs = [], totalDistanceAllTrips = 0;
let isTracking = false;

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ†
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
function initMap() {
  map = L.map('map').setView([25.276987, 55.296249], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ù†Ù‚Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø©
function updateMap(lat, lon) {
  const newPoint = [lat, lon];
  pathCoords.push(newPoint);

  if (!pathLine) {
    pathLine = L.polyline(pathCoords, { color: 'blue' }).addTo(map);
  } else {
    pathLine.setLatLngs(pathCoords);
  }

  map.setView(newPoint, 15);
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§ÙƒØªØ´Ø§Ù Ø­Ø±ÙƒØ©
function detectDriving() {
  if (watchId) navigator.geolocation.clearWatch(watchId);

  watchId = navigator.geolocation.watchPosition(pos => {
    const { latitude, longitude, speed } = pos.coords;

    if (speed && speed > 2 && !isTracking) {
      startTracking(); // â¬…ï¸ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    }
  }, () => {
    document.getElementById("status").textContent = "ğŸ“µ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹";
  }, { enableHighAccuracy: true });
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØªØ¨Ø¹ ÙŠØ¯ÙˆÙŠÙ‹Ø§
function manualStart() {
  if (!isTracking) {
    startTracking();
  }
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„ÙƒØ§Ù…Ù„
function startTracking() {
  totalDistance = 0;
  maxSpeed = 0;
  pathCoords = [];
  pathLine = null;
  sessionStartCoords = null;
  sessionEndCoords = null;
  lastPosition = null;
  document.getElementById("distance").textContent = "0";
  document.getElementById("speed").textContent = "0";
  document.getElementById("driveTime").textContent = "0";

  initMap();
  startTime = new Date();
  isTracking = true;
  clearInterval(driveInterval);
  driveInterval = setInterval(updateDriveTime, 1000);

  watchId = navigator.geolocation.watchPosition(pos => {
    const { latitude, longitude, speed } = pos.coords;

    updateMap(latitude, longitude);

    if (speed !== null && !isNaN(speed)) {
      const kmh = (speed * 3.6).toFixed(1);
      document.getElementById("speed").textContent = kmh;
      if (speed * 3.6 > maxSpeed) maxSpeed = speed * 3.6;
    }

    if (!sessionStartCoords) sessionStartCoords = [latitude, longitude];
    sessionEndCoords = [latitude, longitude];

    if (lastPosition) {
      const dist = haversine(lastPosition.latitude, lastPosition.longitude, latitude, longitude);
      if (dist > 0.01) {
        totalDistance += dist;
        document.getElementById("distance").textContent = totalDistance.toFixed(2);
        clearTimeout(autoStopTimeout);
        autoStopTimeout = setTimeout(stopTracking, 60000); // â±ï¸ Ø§Ù„ØªÙˆÙ‚Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ 60 Ø«Ø§Ù†ÙŠØ© ØªÙˆÙ‚Ù
      }
    }

    lastPosition = { latitude, longitude };
    document.getElementById("status").textContent = "ğŸš— Ø§Ù„ØªØªØ¨Ø¹ Ù†Ø´Ø·...";
  }, () => {
    document.getElementById("status").textContent = "ğŸ“µ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØªØ¨Ø¹";
  }, { enableHighAccuracy: true });
}
</script>
<script>
// Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØªØ¨Ø¹ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
function stopTracking() {
  if (watchId) navigator.geolocation.clearWatch(watchId);
  if (driveInterval) clearInterval(driveInterval);
  clearTimeout(autoStopTimeout);
  isTracking = false;

  document.getElementById("status").textContent = "â›” ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØªØ¨Ø¹";

  const now = new Date();
  const elapsedMs = now - startTime;
  const totalSeconds = Math.floor(elapsedMs / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  const formattedDuration = `${hours} Ø³ ${minutes} Ø¯ ${seconds} Ø«`;

  const log = {
    start: sessionStartCoords,
    end: sessionEndCoords,
    distance: totalDistance.toFixed(2),
    duration: formattedDuration,
    maxSpeed: maxSpeed.toFixed(1)
  };

  // Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„
  driveLogs.push(log);
  totalDistanceAllTrips += totalDistance;
  localStorage.setItem("driveLogs", JSON.stringify(driveLogs));
  localStorage.setItem("totalDistanceAllTrips", totalDistanceAllTrips);

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
  const currentBase = parseFloat(localStorage.getItem("currentKm") || 0);
  localStorage.setItem("currentKm", (currentBase + totalDistance).toFixed(2));

  // Ø®ØµÙ… Ù…Ù† Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ØªØ±ÙˆÙ„
  const currentFuel = parseFloat(localStorage.getItem("fuelRange") || 0);
  localStorage.setItem("fuelRange", (currentFuel - totalDistance > 0 ? currentFuel - totalDistance : 0).toFixed(2));

  generateRSS();
  renderDriveLogs();
  updateOdometer();
  updateFuelCounter();
  checkServiceAlert();
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­ÙŠ
function updateDriveTime() {
  const now = new Date();
  const elapsedMs = now - startTime;
  const totalSeconds = Math.floor(elapsedMs / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  const formatted = `${hours} Ø³ ${minutes} Ø¯ ${seconds} Ø«`;
  document.getElementById("driveTime").textContent = formatted;
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª
function updateOdometer() {
  const base = parseFloat(localStorage.getItem("currentKm") || 0);
  const added = parseFloat(localStorage.getItem("totalDistanceAllTrips") || 0);
  const liveTrip = totalDistance;

  const total = base + added + liveTrip;

  document.getElementById("baseKm").textContent = base.toFixed(2);
  document.getElementById("addedKm").textContent = (added + liveTrip).toFixed(2);
  document.getElementById("totalKm").textContent = total.toFixed(2);

  if (!isTracking) {
    document.getElementById("currentKm").value = (base + added).toFixed(2);
  }
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ØªØ±ÙˆÙ„
function updateFuelCounter() {
  const fuelLeft = parseFloat(localStorage.getItem("fuelRange") || 0);
  document.getElementById("fuelStart").textContent = fuelLeft.toFixed(2);
  document.getElementById("fuelLeft").textContent = fuelLeft.toFixed(2);
  document.getElementById("fuelRange").value = fuelLeft.toFixed(2);
}
</script>
<script>
// Ø¥Ù†Ø´Ø§Ø¡ RSS Ù„Ù„Ø±Ø­Ù„Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
function generateRSS() {
  const logs = JSON.parse(localStorage.getItem("driveLogs") || "[]");
  let rssContent = `<?xml version="1.0" encoding="UTF-8" ?>\n<rss version="2.0">\n<channel>\n`;
  rssContent += `<title>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© - Ù…ÙŠØ²Ø§Ù†ÙŠ</title>\n<link>https://example.com/</link>\n<description>Ø®Ù„Ø§ØµØ§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª</description>\n`;

  logs.forEach((log, index) => {
    const pubDate = new Date().toUTCString();
    rssContent += `<item>\n<title>Ø±Ø­Ù„Ø© ${index + 1}</title>\n`;
    rssContent += `<description>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${log.distance} ÙƒÙ… - Ø§Ù„Ù…Ø¯Ø©: ${log.duration} - Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ù‚ØµÙˆÙ‰: ${log.maxSpeed} ÙƒÙ…/Ø³</description>\n`;
    rssContent += `<pubDate>${pubDate}</pubDate>\n</item>\n`;
  });

  rssContent += `</channel>\n</rss>`;
  localStorage.setItem("rssFeed", rssContent);
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
function renderDriveLogs() {
  const container = document.getElementById("driveLogs");
  container.innerHTML = "";
  const logs = JSON.parse(localStorage.getItem("driveLogs") || "[]");
  driveLogs = logs;

  logs.forEach((log, index) => {
    const div = document.createElement("div");
    div.className = "box";
    div.innerHTML = `
      <strong>Ø±Ø­Ù„Ø© #${index + 1}</strong><br>
      ğŸ—ºï¸ Ù…Ù†: [${log.start?.[0]?.toFixed(4)}, ${log.start?.[1]?.toFixed(4)}]<br>
      ğŸ“ Ø¥Ù„Ù‰: [${log.end?.[0]?.toFixed(4)}, ${log.end?.[1]?.toFixed(4)}]<br>
      â±ï¸ Ø§Ù„Ù…Ø¯Ø©: ${log.duration}<br>
      ğŸš— Ø§Ù„Ù…Ø³Ø§ÙØ©: ${log.distance} ÙƒÙ…<br>
      ğŸš€ Ø£Ø¹Ù„Ù‰ Ø³Ø±Ø¹Ø©: ${log.maxSpeed} ÙƒÙ…/Ø³
    `;
    container.appendChild(div);
  });
}

// Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
function resetAllData() {
  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.")) {
    localStorage.removeItem("driveLogs");
    localStorage.removeItem("totalDistanceAllTrips");
    localStorage.removeItem("rssFeed");
    totalDistanceAllTrips = 0;
    driveLogs = [];
    renderDriveLogs();
    updateOdometer();
    updateFuelCounter();
    alert("ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.");
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.onload = () => {
  totalDistanceAllTrips = parseFloat(localStorage.getItem("totalDistanceAllTrips") || 0);

  const savedKm = localStorage.getItem("currentKm");
  const savedFuel = localStorage.getItem("fuelRange");
  const savedServiceDate = localStorage.getItem("lastServiceDate");

  if (savedKm !== null) document.getElementById("currentKm").value = savedKm;
  if (savedFuel !== null) document.getElementById("fuelRange").value = savedFuel;
  if (savedServiceDate !== null) document.getElementById("lastServiceDate").value = savedServiceDate;

  renderDriveLogs();
  updateOdometer();
  updateFuelCounter();
  checkServiceAlert();

  // Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª ÙŠØ¯ÙˆÙŠÙ‹Ø§
  document.getElementById("currentKm").addEventListener("input", function () {
    const val = parseFloat(this.value);
    if (!isNaN(val)) {
      localStorage.setItem("currentKm", val.toFixed(2));
      updateOdometer();
      checkServiceAlert();
    }
  });

  // Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ØªØ±ÙˆÙ„ ÙŠØ¯ÙˆÙŠÙ‹Ø§
  document.getElementById("fuelRange").addEventListener("input", function () {
    const val = parseFloat(this.value);
    if (!isNaN(val)) {
      localStorage.setItem("fuelRange", val.toFixed(2));
      updateFuelCounter();
    }
  });

  // Ø§Ø³ØªØ´Ø¹Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØªØ¨Ø¹
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(pos => {
      const spd = pos.coords.speed;
      if (spd !== null && spd > 2 && !isTracking) {
        startTracking(); // ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
      }
    }, null, { enableHighAccuracy: true });
  }
};
</script>
